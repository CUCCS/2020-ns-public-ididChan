# Exp-07.2 基于Juice Shop的漏洞利用

### 1. 实验目的

- [x] 了解常见 Web 漏洞训练平台

- [x] 了解常见 Web 漏洞的基本原理；

- [x] 掌握 OWASP Top 10 及常见 Web 高危漏洞的漏洞检测、漏洞利用和漏洞修复方法

### 2. 实验要求

- [x] 完成不少于 5 种不同漏洞类型的漏洞利用练习

- [x] （可选）使用不同于官方教程中的漏洞利用方法完成目标漏洞利用练习

  *（注：参考Solution的题解已在实验报告中注明）

- [x] （可选）定位缺陷代码

- [x] （可选）尝试从源代码层面修复漏洞

### 3. 实验环境

- docker.io 19.03.13+dfsg1-2

- Juice Shop

### 4. 实验完成度

### 5. 实验准备

- Juice Shop漏洞攻防训练环境搭建

    ```cmd
    # 在 /etc/apt/sources.list 中添加 Docker 官方的 apt 镜像源地址
    if [[ $(grep -c "docker.com" /etc/apt/sources.list) -eq 0 ]];then echo "deb https://download.docker.com/linux/debian buster stable" >> /etc/apt/sources.list;fi
    # 添加 Docker 官方的 GPG 公钥到系统受信任公钥数据库
    curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
    apt-get update
    # 安装docker-ce
    apt-get install docker-ce
    # 注：容器部分使用Exp-7.1中下载好的ctf-games
    # 切换工作目录
    cd /home/idchannov/workspace/ctf-games/owasp/juice-shop
    # 启动 webgoat 系列服务
    docker-compose up -d
    # 查看当前容器状态
    docker ps
    ```

    ![img](img/prep-before.PNG)

    ![img](img/prep-after.PNG)

    ![img](img/compose-finish.PNG)

    ![img](img/docker-status.PNG)

    ![img](img/juice-shop-start.PNG)

### 6. 漏洞利用

- **Finding the Score Board**(⭐)

    - 方法一：在网页内点击各种按钮观察URL，发现网页的访问链接是以`127.0.0.1:3000/#/content`的形式组织的，在尝试 score 和 board 的各种组合后，发现输入`127.0.0.1:3000/#/score-board`可以成功访问计分板
    
    - 方法二：在FireFox - Inspect Element中搜索关键词

        ![img](img/score-board-search.PNG)

    ![img](img/score-board.PNG)

- **Injection**

    - Christmas Special(⭐⭐⭐)

        1. 在Burp Suite中观察请求特征，发现可能可以通过`http://127.0.0.1:3000/rest/products/search?q=xxx`查找到商品信息，进行尝试后发现确实如此

            ![img](img/christmas-deleted-request.PNG)

            ![img](img/christmas-deleted-try.PNG)

        2. 进行SQL注入攻击得到被删除的商品信息

            ![img](img/christmas-deleted-info.PNG)

        3. 尝试购买商品，在Burp Suite中观察请求特征，找到可能与将商品加入购物车的请求后发送至Repeater，修改参数后发送，这样可将被删除的商品加入购物车，结账后即可完成实验

            ![img](img/christmas-deleted-edit.PNG)

            ![img](img/christmas-deleted-basket.PNG)

        ![img](img/christmas-deleted.PNG)

    - Login Admin(⭐⭐)

        进行SQL注入攻击，输入语句为`admin@juice-sh.op'--`

        ![img](img/login-admin.PNG)

    - Login Bender(⭐⭐⭐)（参考Solution）
    
        进行SQL注入攻击，输入语句为`bender@juice-sh.op'--`

        ![img](img/login-bender.PNG)

        **疑问：** 不知道这个邮箱名称是咋猜到的，是Juice Shop的内置用户都有默认后缀吗？

    - Login Jim(⭐⭐⭐)

        1. 猜测Jim的邮箱，盲猜前缀是jim

        2. 进行SQL注入攻击，发现使用邮箱jim@juice-sh.op可以成功登录，输入语句为`jim@juice-sh.op'--`

        ![img](img/login-jim.PNG)

    - User Credentials(⭐⭐⭐⭐)

        之前在Christmas Special题目中通过`http://127.0.0.1:3000/rest/products/search?q=xxx`查找到了商品信息，因此目前在不知道user的查询路径&是否有准确的查询路径的条件下可以通过UNION SQL攻击的方式得到目标数据库，注入语句如下：

        ```
        http://127.0.0.1:3000/rest/products/search?q=qwert')) UNION SELECT id, email, password, lastLoginIp, profileImage, '6', '7', '8', '9' FROM Users--
        ```

        注：由于在Log in with Chris' erased user account与Christmas Special中已经知道了用户与商品的数据库存储结构，所以这里不需要经过太多次的注入尝试，但实际情况中需要根据网页响应来逐步调整注入语句

        ![img](img/user-credentials-attack.PNG)

        ![img](img/user-credentials.PNG)

    - Database Schema(⭐⭐⭐)

        注入原理同User Credentials，但略有不同的是此次注入攻击中连接的表为sqlite_master，注入语句如下：

        ```
        http://127.0.0.1:3000/rest/products/search?q=qwert')) UNION SELECT sql, type, name, tbl_name, rootpage, '6', '7', '8', '9' FROM sqlite_master--
        ```

        ![img](img/entire-db-info.PNG)

        ![img](img/entire-db.PNG)

- **Broken Authentication**

    - Bjoern's Favorite Pet(⭐⭐⭐)

        1. 根据题目的Hint在google上搜索关键词后出现下图所示的信息

            ![img](img/forget-password-media.PNG)

        2. 一开始误以为Bjoern的个人信息会暴露在Twitter之类的社交平台比较多而忽略了题目给出的指向视频的信息提示所以浪费了很多力气qwq……最后根据Solution在上图圈出的视频中找到了Bjoern某次在演示平台搭建的时候创建的账户，之后输入密保问题答案即可完成实验

            ![img](img/forget-password-answer.PNG)

            ![img](img/forget-password.PNG)

            **【？】** 虽然对于这个简易平台来说用户账户的密保问题指向性相对较为明确，但在实际情况中估计还是得用python爬一下的，但目前没有想出怎么提取视频的具体内容……所以最终还是得一个一个盲看吗？？？这种教学视频我肯定第一个跳过啊qwq

    - Change Bender's Password(⭐⭐⭐⭐)

        1. 使用SQL注入的方式登入Bender的帐号

        2. 在Burp Suite中查看token并解码如下，得到用户密码的MD5编码结果

            ![img](img/reset-passwd-decode.PNG)

        3. 暴力破解MD5得到用户密码，并修改（目前未解密成功）

    - Log in with Chris' erased user account(⭐⭐⭐)

        1. 在登录界面输入`\' or deletedAt IS NOT NULL--`登录后在Burp Suite中查看被软删除的账户信息

            ![img](img/login-erase-account.PNG)

        2. 使用以上得到的用户邮箱进行SQL注入攻击，输入`chris.pike@juice-sh.op'--`登入chris的帐号

            ![img](img/login-erase.PNG)

    - Password Strength(⭐⭐)

        解码token信息，暴力破解admin账户密码（admin123）

        ![img](img/password-strength-token.PNG)

        ![img](img/password-strength.PNG)

    - Reset Jim's Password(⭐⭐⭐)

        1. 使用SQL注入攻击登入Jim的帐号，查找可能与Jim的身份相关的信息，在My saved addresses中找到如下信息：
           
            ![img](img/login-jim-info.PNG)

        2. 在google中输入关键字搜索，筛查到符合条件的人物信息，并查看其家庭关系，发现Samuel为密保问题的答案

            ![img](img/login-jim-search.PNG)

            <img src="img/login-jim-family.PNG" alt="img" style="zoom:50%;" />

        3. 更改密码即可完成实验

            ![img](img/jim-password-reset.PNG)

- **Security Misconfiguration**

    - Deprecated Interface(⭐⭐)

        1. 为了完成这个实验，我们需要找到网页与本地交互的接口，查看网页功能后发现隐藏的侧边栏中Complaint正好可以满足这个需求

        2. 虽然上传文件的界面中默认过滤除了.pdf与.zip以外的所有文件，但选择了`All Files`选项后该过滤功能即可被屏蔽，之后随便写一个.xml脚本即可完成实验

            ![img](img/deprecated-interface-xml.PNG)

        ![img](img/deprecated-interface.PNG)

    - Error Handling(⭐)

        至今没想明白这个实验我是怎么完成的，似乎是在探索网页功能的时候莫名其妙就结束了？？？

        ![img](img/error-handling.PNG)

- **Improper Input Validation**

    - Missing Encoding(⭐)

        1. 打开FireFox - Inspect Element寻找线索，找到一条疑似在twitter上发文的链接后打开如下：

            ![img](img/missing-encoding-tweet.PNG)

            按照URL内容，tweet的内容应该为：😼 #zatschi #whoneedsfourlegs @owasp_juiceshop #appsec ，但此时后面的内容却被截断，因此推测是编码的锅，且问题出在`#`上

        2. 更改twitter发文URL的编码，将`#`更改为`%23`，发现内容可以正常显示

            ![img](img/missing-encoding-rev.PNG)

        3. 返回原页面，更改URL后即可完成实验
        
            （歪个楼，Zaya真可爱！

            ![img](img/missing-encoding.PNG)

    - Repetitive Registration(⭐)

        1. 随便注册一个账户，在Burp Suite中找到与注册有关的请求，并发送至Repeater

            ![img](img/repetitive-registration-request.PNG)

        2. 将passwordRepeat置为空后更改注册用户名，发送后即可完成实验

            ![img](img/repetitive-registration-edit.PNG)

        ![img](img/repetitive-registration.PNG)

    - Zero Stars(⭐)

        1. 先给个好评，在Burp Suite中找到与注册有关的请求，并发送至Repeater

            ![img](img/zero-stars-request.PNG)

        2. 将rating置为0后发送即可完成实验

            ![img](img/zero-stars-edit.PNG)

        ![img](img/zero-stars.PNG)

    - Admin Registration(⭐⭐⭐)

        1. 在Burp Suite中找到与注册有关的请求，并发送至Repeater

            ![img](img/repetitive-registration-request.PNG)

        2. 更改用户名并删除密保问题与答案部分，发送即可完成实验

            ![img](img/admin-registration-edit.PNG)

        ![img](img/admin-registration.PNG)

    - Payback Time(⭐⭐⭐)

        1. 当购物车中物品数量为正数时，结账时账户的余额会减少，因此完成此项实验一个最直接的思路是：让购物车中的物品数量为负数

        2. 由于网页界面不支持将商品数量改为负数，因此需在Burp Suite中找到与将商品加入购物车有关的请求，并发送至Repeater，之后将商品数量修改为负数，结账后即可完成实验

            ![img](img/payback-time-edit.PNG)

            操作结果如下：

            ![img](img/payback-time-basket.PNG)

        ![img](img/payback-time.PNG)

    - Upload Size(⭐⭐⭐)

        1. 在FireFox - Inspect Element - Debugger中找到与上传文件有关的源码main-es2018.js，进入容器中对文件上传长度限制的部分进行修改（原本为1e5），并重建容器

            ![img](img/upload-size-code.PNG)

        2. 回到Complaint页面进行文件上传，此时上传大于100KB的文件不会报错，也可以成功提交，但不知道为什么没有完成挑战的提醒，但按照题解将文件格式改为.pdf以后就可以成功上传（希望可以蹲到一个解答qwq

            <img src="img/upload-size-commit.PNG" alt="img" style="zoom:50%;" />

            <img src="img/upload-size-info.PNG" alt="img" style="zoom:45%;" />

        ![img](img/upload-size.PNG)

    - Upload Type(⭐⭐⭐)

        1. 同上，进入容器对main-es2018.js进行修改，增加要上传的文件类型，并重建容器

            ![img](img/upload-type-code.PNG)

        2. 在Burp Suite中找到与上传文件相关的请求发送至Repeater，修改相关参数后发送即可完成实验

            ![img](img/upload-type-edit.PNG)

        ![img](img/upload-type.PNG)

- **Broken Access Control**

    - Admin Section(⭐⭐)

        之前做实验的时候在Burp中看见了请求URL中有administration字样，因此路径比较好猜；登入admin账户输入`127.0.0.1:3000/#/administration`即可完成访问

        ![img](img/admin-section.PNG)

    - Five-Star Feedback(⭐⭐)

        使用admin账户登入后访问`127.0.0.1:3000/#/administration`，删除5星好评即可

        ![img](img/five-star-feedback.PNG)

    - Forged Feedback(⭐⭐⭐)

        1. 随便登入一个帐号发布反馈，在Burp Suite中截取请求

        2. 登入另一个帐号，将刚才的请求修改反馈信息后重发（该操作的目的是为了保留token）

            ![img](img/forged-feedback-edit.PNG)

        ![img](img/forged-feedback.PNG)

    - Forged Review(⭐⭐⭐)

        1. 随便挑选一个商品发表好评，发现在Burp Suite中截取不到相关请求，于是打开FireFox - Inspect Element - Network，发现在PUT请求中包含了评论的相关信息

            ![img](img/forged-review-put.PNG)

        2. 更改请求中的message和author参数并发送即可

            <img src="img/forged-review-comment.PNG" alt="img" style="zoom:50%;" />

        ![img](img/forged-review.PNG)

    - Manipulate Basket(⭐⭐⭐)

        1. 将商品加入购物车后在Burp Suite中观察请求特征，找到与加购商品相关的请求后发送至Repeater

        2. 在Repeater中编辑请求参数，最直接的想法是更改BasketId，但单纯修改BasketId后发送会报错如下：

            ![img](img/manipulate-basket-error.PNG)

            因此选择在原来的BasketId后增加其他的BasketId，发送后即可完成实验

            ![img](img/manipulate-basket-edit.PNG)

        ![img](img/manipulate-basket.PNG)

    - View Basket(⭐⭐)

        在FireFox - Inspect Element - Storage - Session Storage中修改bid（basketId）即可查看不同用户的购物车信息

        ![img](img/basket-bid-1.PNG)

        ![img](img/basket-bid-2.PNG)

        ![img](img/basket-bid-3.PNG)

        ![img](img/basket-bid-4.PNG)

        ![img](img/basket-bid-5.PNG)

### 7. 遇到的问题

- 访问Juice Shop时显示`403 Forbidden`

    **出错原因：** 代理端口发生冲突

    **解决方法：** 重新设置代理端口，并在Burp Suite中对之进行监听

    ![img](img/p1-proxy.PNG)

    ![img](img/p1-burp.PNG)

- 容器juice-shop中无法使用apt

    **解决方法：** 使用apk替代即可


### 8. 参考资料

- [Juice Shop Official Documents](https://bkimminich.gitbooks.io/pwning-owasp-juice-shop/content/)

- [Juice Shop Official Solutions](https://bkimminich.gitbooks.io/pwning-owasp-juice-shop/content/appendix/solutions.html)

- [SQL injection UNION attacks](https://portswigger.net/web-security/sql-injection/union-attacks)

- [The Schema Table | SQLite](https://sqlite.org/schematab.html)

- [Frequently Asked Questions | SQLite](https://www.sqlite.org/faq.html)

- [XML External Entity (XXE) Processing](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing)

- [How to run vi on docker container?](https://stackoverflow.com/questions/31515863/how-to-run-vi-on-docker-container)