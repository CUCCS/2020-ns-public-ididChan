# Exp-05 基于 Scapy 编写端口扫描器

### 1. 实验目的

- [x] 掌握网络扫描之端口状态探测的基本原理

### 2.  实验要求

- [x] 禁止探测互联网上的 IP ，严格遵守网络安全相关法律法规
- [x] 完成以下扫描技术的编程实现
  - TCP connect scan / TCP stealth scan
  - TCP Xmas scan / TCP fin scan / TCP null scan
  - UDP scan
- [x] 上述每种扫描技术的实现测试均需要测试端口状态为：`Open`、`Closed` 和 `Filtered` 状态时的程序执行结果
- [x] 提供每一次扫描测试的抓包结果并分析与课本中的扫描方法原理是否相符？如果不同，试分析原因；
- [x] 在实验报告中详细说明实验网络环境拓扑、被测试IP的端口状态是如何模拟的
- [x] （可选）复刻 `nmap` 的上述扫描技术实现的命令行参数开关

### 3. 实验环境

- 网络拓扑

  ![img](img/topo.PNG)

- 节点信息描述

  |   虚拟机名称   |      网卡选择      |                       IP地址                        |
  | :------------: | :----------------: | :-------------------------------------------------: |
  | gateway-ubuntu |  NAT网络，ID-net   |                     10.0.2.4/24                     |
  |                |   Host-Only网络    |                  192.168.56.106/24                  |
  |                | 内部网络，intnet-1 |                  172.20.10.1/24                   |
  |  victim-xp-1   | 内部网络，intnet-1 | 172.20.10.30/24  |
  |  victim-kali   | 内部网络，intnet-1 | 172.20.10.133/24 |
  | attacker-intnet  |  NAT网络，ID-net   |                    172.20.10.147/24                     |


- 软件环境

  - python-3.8.4

  - scapy 2.4.3-4

  - argparse-1.4.0

### 4. 「Client - Server」行为分析

- **TCP connect** 
端口状态为`Open` / `Closed` / `Filtered`的客户机在进行TCP connect扫描时不同之处在于服务器向客户机发送的响应包

  - 端口状态为`Open`

    > TCP Flags = 18(SA) 

    <img src="img/connect-open.PNG" alt="img" style="zoom:40%;" />

  - 端口状态为`Closed`

    > TCP Flags = 20(RA)

    <img src="img/connect-closed.PNG" alt="img" style="zoom:40%;" />

  - 端口状态为`Filtered`
  
    <img src="img/connect-filtered.PNG" alt="img" style="zoom:40%;" />

- **TCP SYN(stealth)** 

  SYN scan基于TCP握手机制（详见上图），因此同样可以通过服务器发送的相应包判断端口状态，但与TCP connect scan不同的是它「不需完成完整的TCP连接」

  - 端口状态为`Open`

    > TCP Flags = 18(SA) 

    <img src="img/syn-connect.PNG" alt="img" style="zoom:40%;" />

  - 端口状态为`Closed`&emsp;同TCP connect

  - 端口状态为`Filtered`&emsp;同TCP connect

- **TCP Xmas**

  - 端口状态为`Open`/`Closed`/`Filtered`

    <img src="img/xmas-open.PNG" alt="img" style="zoom:40%;" />

  - 端口状态为`Closed`

    > TCP Flags = 20(RA)

  <img src="img/xmas-closed.PNG" alt="img" style="zoom:40%;" />

- **TCP FIN**

  - 端口状态为`Open`/`Closed`/`Filtered`

    <img src="img/fin-open.PNG" alt="img" style="zoom:40%;" />

  - 端口状态为`Closed`

    > TCP Flags = 20(RA)

    <img src="img/fin-closed.PNG" alt="img" style="zoom:40%;" />

- **TCP NULL**

  - 端口状态为`Open`/`Closed`/`Filtered`

    <img src="img/null-open.PNG" alt="img" style="zoom:40%;" />

  - 端口状态为`Closed`

    > TCP Flags = 20(RA)

    <img src="img/null-closed.PNG" alt="img" style="zoom:40%;" />

- **UDP**

  - 端口状态为`Open`
  
    <img src="img/udp-open.PNG" alt="img" style="zoom:40%;" />
  
  - 端口状态为`Open`/`Closed`/`Filtered`
  
    <img src="img/udp-closed.PNG" alt="img" style="zoom:40%;" />

### 5. 端口状态模拟

- victim-kali

  - 端口状态为`Open`：用python开启本地HTTP服务

    ```cmd
    python -m SimpleHTTPServer port_id
    ```

  - 端口状态为`Closed`：`CTRL` + `C`退出本地HTTP服务

  - 端口状态为`Filtered`：添加防火墙规则

    ```cmd
    # 过滤TCP端口
    iptables -I INPUT -p tcp --dport port_id -j DROP
    # 过滤UDP端口
    iptables -I INPUT -p udp --dport port_id -j DROP
    ```

- victim-windows

  - 端口状态为`Open`：在开启防火墙的前提下为防火墙添加「例外」

    <img src="img/win_iptables.PNG" alt="img" style="zoom:50%;" />

  - 端口状态为`Closed`：不太清楚怎么关闭，因此实验时选用了没有开启的端口

  - 端口状态为`Filtered`：在开启防火墙的前提下取消勾选「例外」

### 6. 实验结果

- **TCP connect scan**

  - 端口状态为`Open`

    - victim-kali

      ![img](img/py-connect-open.PNG)

      ![img](img/nmap-connect-open.PNG)

    - victim-xp-1

      ![img](img/py-connect-open-xp.PNG)

      ![img](img/nmap-connect-open-xp.PNG)

  - 端口状态为`Closed`

    - victim-kali

      ![img](img/py-connect-closed.PNG)

      ![img](img/nmap-connect-closed.PNG)

    - victim-xp-1

      ![img](img/py-connect-closed-xp.PNG)

      ![img](img/nmap-connect-closed-xp.PNG)

  - 端口状态为`Filtered`

    - victim-kali

      ![img](img/py-connect-filtered.PNG)

      ![img](img/nmap-connect-filtered.PNG)

    - victim-xp-1

      ![img](img/py-connect-filtered-xp.PNG)

      ![img](img/nmap-connect-filtered-xp.PNG)

- **TCP stealth scan**

  - 端口状态为`Open`

    - victim-kali

      ![img](img/py-syn-open.PNG)

      ![img](img/nmap-syn-open.PNG)

    - victim-xp-1

      ![img](img/py-syn-open-xp.PNG)

      ![img](img/nmap-syn-open-xp.PNG)

  - 端口状态为`Closed`

    - victim-kali

      ![img](img/py-syn-closed.PNG)

      ![img](img/nmap-syn-closed.PNG)

    - victim-xp-1

      ![img](img/py-syn-closed-xp.PNG)

      ![img](img/nmap-syn-closed-xp.PNG)

  - 端口状态为`Filtered`

    - victim-kali
      
      ![img](img/py-syn-filtered.PNG)
      
      ![img](img/nmap-syn-filtered.PNG)
      
    - victim-xp-1

      ![img](img/py-syn-filtered-xp.PNG)

      ![img](img/nmap-syn-filtered-xp.PNG)
  
- **TCP Xmas scan**

  - 端口状态为`Open`

    - victim-kali

      ![img](img/py-xmas-open.PNG)

      ![img](img/nmap-xmas-open.PNG)

    - victim-xp-1

      ![img](img/py-xmas-open-xp.PNG)

      ![img](img/nmap-xmas-open-xp.PNG)

  - 端口状态为`Closed`

    - victim-kali

      ![img](img/py-xmas-closed.PNG)

      ![img](img/nmap-xmas-closed.PNG)

    - victim-xp-1

      ![img](img/py-xmas-closed-xp.PNG)

      ![img](img/nmap-xmas-closed-xp.PNG)
    
  - 端口状态为`Filtered`

    - victim-kali

      ![img](img/py-xmas-filtered.PNG)

      ![img](img/nmap-xmas-filtered.PNG)

    - victim-xp-1

      ![img](img/py-xmas-filtered-xp.PNG)

      ![img](img/nmap-xmas-filtered-xp.PNG)

- **TCP FIN scan**

  - 端口状态为`Open`

    - victim-kali

      ![img](img/py-fin-open.PNG)

      ![img](img/nmap-fin-open.PNG)

    - victim-xp-1

      ![img](img/py-fin-open-xp.PNG)

      ![img](img/nmap-fin-open-xp.PNG)

  - 端口状态为`Closed`

    - victim-kali

      ![img](img/py-fin-closed.PNG)

      ![img](img/nmap-fin-closed.PNG)

    - victim-xp-1

      ![img](img/py-fin-closed-xp.PNG)

      ![img](img/nmap-fin-closed-xp.PNG)


  - 端口状态为`Filtered`

    - victim-kali

      ![img](img/py-fin-filtered.PNG)

      ![img](img/nmap-fin-filtered.PNG)

    - victim-xp-1

      ![img](img/py-fin-filtered-xp.PNG)

      ![img](img/nmap-fin-filtered-xp.PNG)

- **TCP NULL scan**

  - 端口状态为`Open`

    - victim-kali

      ![img](img/py-null-open.PNG)

      ![img](img/nmap-null-open.PNG)

    - victim-xp-1

      ![img](img/py-null-open-xp.PNG)

      ![img](img/nmap-null-open-xp.PNG)

  - 端口状态为`Closed`

    - victim-kali

      ![img](img/py-null-closed.PNG)

      ![img](img/nmap-null-closed.PNG)

    - victim-xp-1

      ![img](img/py-null-closed-xp.PNG)

      ![img](img/nmap-null-closed-xp.PNG)

  - 端口状态为`Filtered`

    - victim-kali

      ![img](img/py-null-filtered.PNG)

      ![img](img/nmap-null-filtered.PNG)

    - victim-xp-1

      ![img](img/py-null-filtered-xp.PNG)

      ![img](img/nmap-null-filtered-xp.PNG)

- **UDP scan**

  - 端口状态为`Open`

    - victim-kali

      ![img](img/py-udp-open.PNG)

      ![img](img/nmap-udp-open.PNG)

    - victim-xp-1

      ![img](img/py-udp-open-xp.PNG)

      ![img](img/nmap-udp-open-xp.PNG)

  - 端口状态为`Closed`

    - victim-kali

      ![img](img/py-udp-closed.PNG)

      ![img](img/nmap-udp-closed.PNG)

    - victim-xp-1

      ![img](img/py-udp-closed-xp.PNG)

      ![img](img/nmap-udp-closed-xp.PNG)

  - 端口状态为`Filtered`

    - victim-kali

      ![img](img/py-udp-filtered.PNG)

      ![img](img/nmap-udp-filtered.PNG)

    - victim-xp-1

      ![img](img/py-udp-filtered-xp.PNG)

      ![img](img/nmap-udp-filtered-xp.PNG)

### 7. 遇到的问题

- Windows-XP虚拟机过了激活时限而无法使用

  **错误原因：** 

  - 安装时输入的激活序列号（网上随便找的）与所下载的镜像版本不对应
  
  - 使用基础镜像时没有进行系统安装就将其改为多重加载，导致多重加载的虚拟机没有可能恢复到正常状态

  - 使用多重加载方式搭建的虚拟机没有备份

    **解决方法：** 下载` Windows XP Professional with Service Pack 3 (x86) - CD VL (Chinese-Simplified) `版本镜像，使用老师提供的对应序列号重建实验环境X（
  
    - 虚拟机IP地址变更
  
      `victim-xp-1`：172.20.10.30

      `victim-xp-2`：172.20.35.133

- 攻击者主机构造的TCP包不能正常发送

  **错误原因：** 
  
  - 攻击者主机与靶机不在同一网段 

  - 进程提供网络服务，网络服务使用指定协议和端口，在靶机使用`ufw allow port_id/tcp`指令仅可控制端口是否可达，而无法开启端口对UDP的监听

  **解决方法：** 

  - 使攻击者主机与靶机位于同网段

    【可选】

    - 新建攻击者主机

    - 更改攻击者主机网络设置
  
  - 使用`http-server -p port_id`指令开启本地服务

  **结果展示：**

  <img src="img/solved-1.PNG" alt="img" style="zoom:50%;" />
  
- 用python实现的端口扫描器中args实例报错

  **错误原因：**
  
  - 没有安装argparse模块

  - `add_argument()`语法使用错误，修改后结果如下：

    ![img](img/handle.PNG)

- 使用nmap进行端口扫描时的结果与实际状态不匹配（已在图中用红色框标注）

  【示例】

  <img src="img/prob-3.PNG" alt="img" style="zoom:50%;" />

  <img src="img/prob-3-udp.PNG" alt="img" style="zoom:50%;" />
  
  **原因：** nmap是根据客户机对服务器发包做出的响应对端口状态进行「推断」，而推断具有不确定性，因此与事实不一致属于正常现象
  
- **【Unsolved】** 不知道在Kali上咋打开一个随机的UDP端口啊~TAT~，使用了`python -m SimpleHTTPServer port_id`以及`nc -l -u -p port_num < /etc/passwd`都不咋行，后来就直接简单粗暴的开启了个apache服务，希望可以蹲到一个解决办法: (

- **【Unsolved】** 对于windows-xp的msrpc服务的135端口进行TCP-Xmas/FIN/NULL扫描时，自己写的端口扫描器和nmap会将Open状态误判为Closed（猜测可能是Windows的安全机制？？？）

### 8. 参考资料

- [【CUC】Cyber Security -- (Chapter0x05)Network Scanning PPT](https://c4pr1c3.github.io/cuc-ns-ppt/chap0x05.md.html#/title-slide)

- [【推荐阅读】TCP常见的扫描类型](https://blog.51cto.com/professor/1701977)

- [Guide: Using Scapy with Python](https://santanderglobaltech.com/en/guide-using-scapy-with-python/)

- [Port Scanning using Scapy](https://resources.infosecinstitute.com/port-scanning-using-scapy/)

- [TCP Connect Scan (-sT) | Nmap Network Scanning](https://nmap.org/book/scan-methods-connect-scan.html)

- [TCP SYN (Stealth) Scan (-sS) | Nmap Network Scanning](https://nmap.org/book/synscan.html)

- [TCP FIN, NULL, and Xmas Scans (-sF, -sN, -sX) | Nmap Network Scanning](https://nmap.org/book/scan-methods-null-fin-xmas-scan.html)

- [TCP UDP Scan (-sU) | Nmap Network Scanning](https://nmap.org/book/scan-methods-udp-scan.html)

- [【示例代码】xuanhun/PythonHackingBook1](https://github.com/xuanhun/PythonHackingBook1/blob/1d495637af2b344094e322f34a7ae4d6deae0605/3.7%20%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F/code/portScan.py)

- [argparse --- 命令行选项、参数和子命令解析器](https://docs.python.org/zh-cn/3/library/argparse.html#argparse.ArgumentParser)

- [Linux下scapy运行时报错：No module named scapy](https://www.jianshu.com/p/0967710a3b9f)